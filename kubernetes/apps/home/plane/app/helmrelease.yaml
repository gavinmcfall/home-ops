---
# yaml-language-server: $schema=https://kubernetes-schemas.ok8.sh/helm.toolkit.fluxcd.io/helmrelease_v2beta1.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: plane
spec:
  interval: 30m
  chart:
    spec:
      chart: plane-ce
      version: 1.0.22
      sourceRef:
        kind: HelmRepository
        name: plane
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    planeVersion: stable

    ingress:
      enabled: true
      appHost: "plane.nerdz.cloud"
      ingressClass: "external"
      ingress_annotations:
        nginx.ingress.kubernetes.io/proxy-body-size: "5m"
        external-dns.alpha.kubernetes.io/target: "external.nerdz.cloud"
        gethomepage.dev/enabled: "true"
        gethomepage.dev/group: "Productivity"
        gethomepage.dev/name: "Plane"
        gethomepage.dev/app: "plane-web"
        gethomepage.dev/icon: "https://plane-marketing.s3.ap-south-1.amazonaws.com/plane-readme/plane_logo_.webp"
        gethomepage.dev/description: "Project Management"

    redis:
      local_setup: false
      remote_redis_url: "$(REDIS_URL)" # This refers to the environment variable set in the deployment

    postgres:
      local_setup: false
      remote_pg_url: "$(PLANE_POSTGRES_CONNECTION_STRING)" # This refers to the environment variable set in the deployment

    minio:
      local_setup: false
      remote_minio_url: "$(PLANE_MINIO_CONNECTION_STRING)" # This refers to the environment variable set in the deployment

    web:
      replicas: 1
      memoryLimit: 1000Mi
      cpuLimit: 500m
      image: makeplane/plane-frontend
      pullPolicy: IfNotPresent
      assign_cluster_ip: true

    space:
      replicas: 1
      memoryLimit: 1000Mi
      cpuLimit: 500m
      image: makeplane/plane-space
      pullPolicy: IfNotPresent
      assign_cluster_ip: true

    admin:
      replicas: 1
      memoryLimit: 1000Mi
      cpuLimit: 500m
      image: makeplane/plane-admin
      pullPolicy: IfNotPresent
      assign_cluster_ip: true

    api:
      replicas: 1
      memoryLimit: 1000Mi
      cpuLimit: 500m
      image: makeplane/plane-backend
      pullPolicy: IfNotPresent
      assign_cluster_ip: false
      env:
        - name: PLANE_POSTGRES_CONNECTION_STRING
          valueFrom:
            secretKeyRef:
              name: plane-other-secrets
              key: PLANE_POSTGRES_CONNECTION_STRING
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: plane-other-secrets
              key: PLANE_REDIS_CONNECTION_STRING
        - name: PLANE_MINIO_CONNECTION_STRING
          valueFrom:
            secretKeyRef:
              name: plane-other-secrets
              key: PLANE_MINIO_CONNECTION_STRING
        - name: PLANE_POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: plane-other-secrets
              key: PLANE_POSTGRES_USER
        - name: PLANE_POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: plane-other-secrets
              key: PLANE_POSTGRES_PASSWORD

    worker:
      replicas: 1
      memoryLimit: 1000Mi
      cpuLimit: 500m
      image: makeplane/plane-backend
      pullPolicy: IfNotPresent
      env:
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: plane-other-secrets
              key: PLANE_REDIS_CONNECTION_STRING

    beatworker:
      replicas: 1
      memoryLimit: 1000Mi
      cpuLimit: 500m
      image: makeplane/plane-backend
      pullPolicy: IfNotPresent
      env:
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: plane-other-secrets
              key: PLANE_REDIS_CONNECTION_STRING

    secretRefs:
      planeAppSecrets:
        name: plane-other-secrets

    env:
      pgdb_username: "$(PLANE_POSTGRES_USER)"
      pgdb_password: "$(PLANE_POSTGRES_PASSWORD)"
      pgdb_name: "$(PLANE_POSTGRES_DB)"
      pgdb_remote_url: "$(PLANE_POSTGRES_CONNECTION_STRING)"
      remote_redis_url: "$(PLANE_REDIS_CONNECTION_STRING)"
      aws_access_key: "$(PLANE_MINIO_ACCESS_KEY)"
      aws_secret_access_key: "$(PLANE_MINIO_SECRET_KEY)"
      aws_s3_endpoint_url: "$(PLANE_MINIO_CONNECTION_STRING)"

    Global:
      deploymentAnnotations:
        secret.reloader.stakater.com/reload: "plane-other-secrets"
      envFrom:
        secretRef:
          name: plane-other-secrets
