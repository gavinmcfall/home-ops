---
# yaml-language-server: $schema=https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/external-secrets.io/externalsecret_v1beta1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: &name postiz
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword-connect
  target:
    name: *name
    template:
      engineVersion: v2
      data:
        # Database Init
        INIT_POSTGRES_DBNAME:  &dbName postiz
        INIT_POSTGRES_HOST: &dbHost "{{ .POSTIZ_POSTGRES_HOST }}"
        INIT_POSTGRES_USER: &dbUser "{{ .POSTIZ_POSTGRES_USER }}"
        INIT_POSTGRES_PASS: &dbPass "{{ .POSTIZ_POSTGRES_PASS }}"
        INIT_POSTGRES_SUPER_PASS: "{{ .POSTGRES_SUPER_PASS }}"
        # App Configuration
        DATABASE_URL: "postgresql://{{ .POSTIZ_POSTGRES_USER }}:{{ .POSTIZ_POSTGRES_PASS }}@{{ .POSTIZ_POSTGRES_HOST }}:5432/postiz"
        JWT_SECRET: "{{ .POSTIZ_JWT_SECRET }}"
        # Email Providers
        EMAIL_PROVIDER: "nodemailer"
        EMAIL_HOST: "smtp-relay.home.svc.cluster.local" # smtp host if you choose nodemailer
        EMAIL_PORT: "25" # smtp port if you choose nodemailer
        EMAIL_SECURE: "false" # smtp secure if you choose nodemailer
        EMAIL_FROM_NAME: "Postiz Emailer"
        EMAIL_FROM_ADDRESS: "noreply@${SECRET_DOMAIN}"
        # OIDC
        POSTIZ_GENERIC_OAUTH: "true"
        POSTIZ_OAUTH_URL: "https://id.${SECRET_DOMAIN}"
        POSTIZ_OAUTH_AUTH_URL: "https://id.${SECRET_DOMAIN}/authorize"
        POSTIZ_OAUTH_TOKEN_URL: "https://id.${SECRET_DOMAIN}/api/oidc/token"
        POSTIZ_OAUTH_USERINFO_URL: "https://id.${SECRET_DOMAIN}/api/oidc/userinfo"
        POSTIZ_OAUTH_CLIENT_ID: "{{ .POSTIZ_POCKETID_CLIENT_ID }}"
        POSTIZ_OAUTH_CLIENT_SECRET: "{{ .POSTIZ_POCKETID_CLIENT_SECRET }}"
        NEXT_PUBLIC_POSTIZ_OAUTH_DISPLAY_NAME: "PocketID"
        NEXT_PUBLIC_POSTIZ_OAUTH_LOGO_URL: "https://raw.githubusercontent.com/gavinmcfall/home-ops/refs/heads/main/docs/src/assets/icons/pocket-id-light.png"
        # Cloudflare
        CLOUDFLARE_ACCOUNT_ID: "{{ .CLOUDFLARE_ACCOUNT_ID }}"
        CLOUDFLARE_ACCESS_KEY: "{{ .POSTIZ_CLOUDFLARE_ACCESS_KEY }}"
        CLOUDFLARE_SECRET_ACCESS_KEY: "{{ .POSTIZ_CLOUDFLARE_SECRET_ACCESS_KEY }}"
        CLOUDFLARE_BUCKETNAME: "{{ .POSTIZ_CLOUDFLARE_BUCKETNAME }}"
        CLOUDFLARE_BUCKET_URL: "{{ .POSTIZ_CLOUDFLARE_BUCKET_URL }}"
        CLOUDFLARE_REGION: "auto"
        # AI
        # Social
        DISCORD_CLIENT_ID: "{{ .POSTIZ_DISCORD_CLIENT_ID }}"
        DISCORD_CLIENT_SECRET: "{{ .POSTIZ_DISCORD_CLIENT_SECRET }}"
        DISCORD_BOT_TOKEN_ID: "{{ .POSTIZ_DISCORD_BOT_TOKEN_ID }}"
        REDDIT_CLIENT_ID: "{{ .POSTIZ_REDDIT_CLIENT_ID }}"
        REDDIT_CLIENT_SECRET: "{{ .POSTIZ_REDDIT_CLIENT_SECRET }}"
        X_API_KEY: "{{ .POSTIZ_X_API_KEY }}"
        X_API_SECRET: "{{ .POSTIZ_X_API_SECRET }}"
        YOUTUBE_CLIENT_ID: "{{ .POSTIZ_YOUTUBE_CLIENT_ID }}"
        YOUTUBE_CLIENT_SECRET: "{{ .POSTIZ_YOUTUBE_CLIENT_SECRET }}"
  dataFrom:
    - extract:
        key: postiz
    - extract:
        key: cloudnative-pg
    - extract:
        key: cloudflare
