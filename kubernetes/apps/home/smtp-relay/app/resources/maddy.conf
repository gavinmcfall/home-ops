# define which domains this relay will accept as "local"
$(local_domains) = {env:SENDER_DOMAINS}

state_dir /cache/state
runtime_dir /cache/run

openmetrics tcp://0.0.0.0:{env:SMTP_RELAY_METRICS_PORT} { }

# disable inbound STARTTLS (testing-only)
tls off

hostname {env:SMTP_DOMAIN}

smtp tcp://0.0.0.0:{env:SMTP_RELAY_SMTP_PORT} {
    # only accept mail for your local domains
    local_domains $(local_domains)

    default_source {
        deliver_to &remote_queue
    }
}

target.queue remote_queue {
    target &remote_smtp
}

target.smtp remote_smtp {
    # turn off STARTTLS entirely
    starttls no

    # upstream authentication
    auth plain {env:SMTP_USERNAME} {env:SMTP_PASSWORD}

    # implicit-TLS to your upstream on port 465
    targets tls://{env:SMTP_SERVER}:{env:SMTP_RELAY_SERVER_PORT}
}
