state_dir /dev/shm/maddy/state
runtime_dir /dev/shm/maddy/run

openmetrics tcp://0.0.0.0:{env:SMTP_RELAY_METRICS_PORT} { }

tls off
hostname {env:SMTP_DOMAIN}

$(local_domains) = {env:SENDER_DOMAINS}

smtp tcp://0.0.0.0:{env:SMTP_RELAY_SMTP_PORT} {
    default_source {
        deliver_to &remote_queue
    }
}

target.queue remote_queue {
    target &remote_smtp
}

target.smtp remote_smtp {
    # disable STARTTLS (we’re using implicit TLS only)
    starttls no

    # OAuth2/XOAUTH2 authentication against Gmail
    auth oauthbearer {
        username      {env:SMTP_RELAY_USERNAME}
        client_id     {env:SMTP_OAUTH_CLIENT_ID}
        client_secret {env:SMTP_OAUTH_CLIENT_SECRET}
        refresh_token {env:SMTP_OAUTH_REFRESH_TOKEN}
        token_url     "https://oauth2.googleapis.com/token"
        scope         "https://mail.google.com/"
    }

    # Implicit‐TLS delivery to upstream on port 465
    targets tls://{env:SMTP_RELAY_SERVER}:{env:SMTP_RELAY_SERVER_PORT}
}
