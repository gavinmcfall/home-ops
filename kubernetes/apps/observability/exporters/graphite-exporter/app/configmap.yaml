---
apiVersion: v1
kind: ConfigMap
metadata:
  name: graphite-exporter-config
data:
  # TrueNAS Scale Graphite Metrics Mapping
  # Source: https://github.com/Supporterino/truenas-graphite-to-prometheus
  graphite_mapping.yaml: |
    mappings:

    ################################################
    # memory mapping
    ################################################

    - match: 'truenas\.(.*)\.system\.ram\.(.*)'
      match_type: "regex"
      name: "truenas_physical_memory"
      labels:
        job: "truenas"
        instance: "$${1}"
        kind: "$${2}"

    - match: 'truenas\.(.*)\.mem\.(.*)\.(.*)'
      match_type: "regex"
      name: "truenas_memory_$${2}"
      labels:
        job: "truenas"
        instance: "$${1}"
        kind: "$${3}"

    - match: 'truenas\.(.*)\.system\.swap\.(.*)'
      match_type: "regex"
      name: "truenas_swap"
      labels:
        job: "truenas"
        instance: "$${1}"
        kind: "$${2}"

    ################################################
    # service mapping
    ################################################

    - match: 'truenas\.(.*)\.services\.cpu\.(.*)'
      match_type: "regex"
      name: "truenas_services_cpu"
      labels:
        job: "truenas"
        instance: "$${1}"
        service: "$${2}"

    - match: 'truenas\.(.*)\.services\.io_ops_read\.(.*)'
      match_type: "regex"
      name: "truenas_services_iops"
      labels:
        job: "truenas"
        instance: "$${1}"
        op: "read"
        service: "$${2}"

    - match: 'truenas\.(.*)\.services\.io_ops_write\.(.*)'
      match_type: "regex"
      name: "truenas_services_iops"
      labels:
        job: "truenas"
        instance: "$${1}"
        op: "write"
        service: "$${2}"

    - match: 'truenas\.(.*)\.services\.io_read\.(.*)'
      match_type: "regex"
      name: "truenas_services_io"
      labels:
        job: "truenas"
        instance: "$${1}"
        op: "read"
        service: "$${2}"

    - match: 'truenas\.(.*)\.services\.io_write\.(.*)'
      match_type: "regex"
      name: "truenas_services_io"
      labels:
        job: "truenas"
        instance: "$${1}"
        op: "write"
        service: "$${2}"

    - match: 'truenas\.(.*)\.services\.mem_usage\.(.*)'
      match_type: "regex"
      name: "truenas_services_mem"
      labels:
        job: "truenas"
        instance: "$${1}"
        service: "$${2}"

    ################################################
    # disk smart metrics
    ################################################

    - match: 'truenas\.(.*)\.smart\.log\.smart\.disktemp\.(.*)\.(.*)'
      match_type: "regex"
      name: "truenas_disk_temperature"
      labels:
        job: "truenas"
        instance: "$${1}"
        serial: "$${2}"

    - match: 'truenas\.(.*)\.smart_log_smart\.disktemp\.(.*)\.(.*)'
      match_type: "regex"
      name: "truenas_disk_temperature"
      labels:
        job: "truenas"
        instance: "$${1}"
        serial: "$${2}"

    ################################################
    # disk operation mappings
    ################################################

    - match: 'truenas\.(.*)\.disk\.(.*)\.(.*)'
      match_type: "regex"
      name: "truenas_disk_io"
      labels:
        job: "truenas"
        instance: "$${1}"
        disk: "$${2}"
        op: "$${3}"

    - match: 'truenas\.(.*)\.disk_ops\.(.*)\.(.*)'
      match_type: "regex"
      name: "truenas_disk_io_ops"
      labels:
        job: "truenas"
        instance: "$${1}"
        disk: "$${2}"
        op: "$${3}"

    - match: 'truenas\.(.*)\.disk_ext\.(.*)\.(.*)'
      match_type: "regex"
      name: "truenas_disk_io"
      labels:
        job: "truenas"
        instance: "$${1}"
        disk: "$${2}"
        op: "$${3}"

    - match: 'truenas\.(.*)\.disk_ext_ops\.(.*)\.(.*)'
      match_type: "regex"
      name: "truenas_disk_io_ops"
      labels:
        job: "truenas"
        instance: "$${1}"
        disk: "$${2}"
        op: "$${3}"

    - match: 'truenas\.(.*)\.disk_backlog\.(.*)\.backlog'
      match_type: "regex"
      name: "truenas_disk_io_backlog"
      labels:
        job: "truenas"
        instance: "$${1}"
        disk: "$${2}"

    - match: 'truenas\.(.*)\.disk_busy\.(.*)\.busy'
      match_type: "regex"
      name: "truenas_disk_busy"
      labels:
        job: "truenas"
        instance: "$${1}"
        disk: "$${2}"

    - match: 'truenas\.(.*)\.disk_util\.(.*)\.utilization'
      match_type: "regex"
      name: "truenas_disk_utilization"
      labels:
        job: "truenas"
        instance: "$${1}"
        disk: "$${2}"

    - match: 'truenas\.(.*)\.disk_mops\.(.*)\.(.*)'
      match_type: "regex"
      name: "truenas_disk_io"
      labels:
        job: "truenas"
        instance: "$${1}"
        disk: "$${2}"
        op: "merged_$${3}"

    - match: 'truenas\.(.*)\.disk_ext_mops\.(.*)\.(.*)'
      match_type: "regex"
      name: "truenas_disk_io"
      labels:
        job: "truenas"
        instance: "$${1}"
        disk: "$${2}"
        op: "merged_$${3}"

    - match: 'truenas\.(.*)\.disk_iotime\.(.*)\.(.*)'
      match_type: "regex"
      name: "truenas_disk_iotime"
      labels:
        job: "truenas"
        instance: "$${1}"
        disk: "$${2}"
        op: "$${3}"

    - match: 'truenas\.(.*)\.disk_ext_iotime\.(.*)\.(.*)'
      match_type: "regex"
      name: "truenas_disk_iotime"
      labels:
        job: "truenas"
        instance: "$${1}"
        disk: "$${2}"
        op: "$${3}"

    - match: 'truenas\.(.*)\.disk_qops\.(.*)\.operations'
      match_type: "regex"
      name: "truenas_disk_qops"
      labels:
        job: "truenas"
        instance: "$${1}"
        disk: "$${2}"

    - match: 'truenas\.(.*)\.disk_await\.(.*)\.(.*)'
      match_type: "regex"
      name: "truenas_disk_await"
      labels:
        job: "truenas"
        instance: "$${1}"
        disk: "$${2}"
        op: "$${3}"

    - match: 'truenas\.(.*)\.disk_ext_await\.(.*)\.(.*)'
      match_type: "regex"
      name: "truenas_disk_await"
      labels:
        job: "truenas"
        instance: "$${1}"
        disk: "$${2}"
        op: "$${3}"

    - match: 'truenas\.(.*)\.disk_avgsz\.(.*)\.(.*)'
      match_type: "regex"
      name: "truenas_disk_io_size"
      labels:
        job: "truenas"
        instance: "$${1}"
        disk: "$${2}"
        op: "$${3}"

    - match: 'truenas\.(.*)\.disk_ext_avgsz\.(.*)\.(.*)'
      match_type: "regex"
      name: "truenas_disk_io_size"
      labels:
        job: "truenas"
        instance: "$${1}"
        disk: "$${2}"
        op: "$${3}"

    - match: 'truenas\.(.*)\.disk_svctm\.(.*)\.svctm'
      match_type: "regex"
      name: "truenas_disk_svctm"
      labels:
        job: "truenas"
        instance: "$${1}"
        disk: "$${2}"

    - match: 'truenas\.(.*)\.system\.io\.(.*)'
      match_type: "regex"
      name: "truenas_system_io"
      labels:
        job: "truenas"
        instance: "$${1}"
        op: "$${2}"

    ################################################
    # CPU mapping
    ################################################

    - match: 'truenas\.(.*)\.system\.intr\.interrupts'
      match_type: "regex"
      name: "truenas_interrupts"
      labels:
        job: "truenas"
        instance: "$${1}"
        kind: "hard"

    - match: 'truenas\.(.*)\.system\.cpu\.softirq'
      match_type: "regex"
      name: "truenas_interrupts"
      labels:
        job: "truenas"
        instance: "$${1}"
        kind: "soft"

    - match: 'truenas\.(.*)\.cpu\.(.*)\.softirq'
      match_type: "regex"
      name: "truenas_cpu_softirq"
      labels:
        job: "truenas"
        instance: "$${1}"
        cpu: "$${2}"

    - match: 'truenas\.(.*)\.system\.ctxt\.switches'
      match_type: "regex"
      name: "truenas_context_switches"
      labels:
        job: "truenas"
        instance: "$${1}"

    - match: 'truenas\.(.*)\.system\.cpu\.(.*)'
      match_type: "regex"
      name: "truenas_cpu_total"
      labels:
        job: "truenas"
        instance: "$${1}"
        kind: "$${2}"

    - match: 'truenas\.(.*)\.cputemp\.temperatures\.(.*)'
      match_type: "regex"
      name: "truenas_cpu_temperature"
      labels:
        job: "truenas"
        instance: "$${1}"
        cpu: "cpu$${2}"

    - match: 'truenas\.(.*)\.cpu\.core_throttling\.(.*)'
      match_type: "regex"
      name: "truenas_cpu_throttling"
      labels:
        job: "truenas"
        instance: "$${1}"
        cpu: "$${2}"

    - match: 'truenas\.(.*)\.cpu\.cpufreq\.(.*)'
      match_type: "regex"
      name: "truenas_cpu_frequency"
      labels:
        job: "truenas"
        instance: "$${1}"
        cpu: "$${2}"

    - match: 'truenas\.(.*)\.cpu\.(.*)_cpuidle\.(.*)'
      match_type: "regex"
      name: "truenas_cpu_idlestate"
      labels:
        job: "truenas"
        instance: "$${1}"
        cpu: "$${2}"
        state: "$${3}"

    - match: 'truenas\.(.*)\.cpu\.(.*)\.(.*)'
      match_type: "regex"
      name: "truenas_cpu_usage"
      labels:
        job: "truenas"
        instance: "$${1}"
        cpu: "$${2}"
        kind: "$${3}"

    ################################################
    # process mapping
    ################################################

    - match: 'truenas\.(.*)\.system\.forks\.started'
      match_type: "regex"
      name: "truenas_processes_forks"
      labels:
        job: "truenas"
        instance: "$${1}"

    - match: 'truenas\.(.*)\.system\.processes\.(.*)'
      match_type: "regex"
      name: "truenas_processes"
      labels:
        job: "truenas"
        instance: "$${1}"
        kind: "$${2}"

    - match: 'truenas\.(.*)\.system\.active_processes\.(.*)'
      match_type: "regex"
      name: "truenas_processes"
      labels:
        job: "truenas"
        instance: "$${1}"
        kind: "$${2}"

    ################################################
    # uptime mapping
    ################################################

    - match: 'truenas\.(.*)\.system\.uptime\.uptime'
      match_type: "regex"
      name: "truenas_uptime"
      labels:
        job: "truenas"
        instance: "$${1}"

    - match: 'truenas\.(.*)\.system\.clock_sync_state\.state'
      match_type: "regex"
      name: "truenas_clock_synced"
      labels:
        job: "truenas"
        instance: "$${1}"

    - match: 'truenas\.(.*)\.system\.clock_status\.(.*)'
      match_type: "regex"
      name: "truenas_clock_status"
      labels:
        job: "truenas"
        instance: "$${1}"
        state: "$${2}"

    - match: 'truenas\.(.*)\.system\.clock_sync_offset\.offset'
      match_type: "regex"
      name: "truenas_clock_offset"
      labels:
        job: "truenas"
        instance: "$${1}"

    ################################################
    # load mapping
    ################################################

    - match: 'truenas\.(.*)\.system\.load\.(.*)'
      match_type: "regex"
      name: "truenas_system_load"
      labels:
        job: "truenas"
        instance: "$${1}"
        kind: "$${2}"

    ################################################
    # nfsd mappings
    ################################################

    - match: 'truenas\.(.*)\.nfsd\.(.*)\.(.*)'
      match_type: "regex"
      name: "truenas_nfs_$${2}"
      labels:
        job: "truenas"
        instance: "$${1}"
        op: "$${3}"

    ################################################
    # zfs mappings
    ################################################

    - match: 'truenas\.(.*)\.zfs\.(.*)\.(.*)'
      match_type: "regex"
      name: "truenas_zfs_$${2}"
      labels:
        job: "truenas"
        instance: "$${1}"
        op: "$${3}"

    - match: 'truenas\.(.*)\.zfspool\.state_(.*)\.(.*)'
      match_type: "regex"
      name: "truenas_zfs_pool"
      labels:
        job: "truenas"
        instance: "$${1}"
        pool: "$${2}"
        state: "$${3}"

    ################################################
    # network mappings
    ################################################

    - match: 'truenas\.(.*)\.net\.(.*)\.(.*)'
      match_type: "regex"
      name: "truenas_interface_io"
      labels:
        job: "truenas"
        instance: "$${1}"
        interface: "$${2}"
        op: "$${3}"

    - match: 'truenas\.(.*)\.net_speed\.(.*)\.speed'
      match_type: "regex"
      name: "truenas_interface_speed"
      labels:
        job: "truenas"
        instance: "$${1}"
        interface: "$${2}"

    - match: 'truenas\.(.*)\.net_duplex\.(.*)\.(.*)'
      match_type: "regex"
      name: "truenas_interface_duplex"
      labels:
        job: "truenas"
        instance: "$${1}"
        interface: "$${2}"
        state: "$${3}"

    - match: 'truenas\.(.*)\.net_operstate\.(.*)\.(.*)'
      match_type: "regex"
      name: "truenas_interface_operationstate"
      labels:
        job: "truenas"
        instance: "$${1}"
        interface: "$${2}"
        state: "$${3}"

    - match: 'truenas\.(.*)\.net_carrier\.(.*)\.(.*)'
      match_type: "regex"
      name: "truenas_interface_carrierstate"
      labels:
        job: "truenas"
        instance: "$${1}"
        interface: "$${2}"
        state: "$${3}"

    - match: 'truenas\.(.*)\.net_mtu\.(.*)\.mtu'
      match_type: "regex"
      name: "truenas_interface_mtu"
      labels:
        job: "truenas"
        instance: "$${1}"
        interface: "$${2}"

    - match: 'truenas\.(.*)\.net_packets\.(.*)\.(.*)'
      match_type: "regex"
      name: "truenas_interface_packets"
      labels:
        job: "truenas"
        instance: "$${1}"
        interface: "$${2}"
        op: "$${3}"

    - match: 'truenas\.(.*)\.net_errors\.(.*)\.(.*)'
      match_type: "regex"
      name: "truenas_interface_errors"
      labels:
        job: "truenas"
        instance: "$${1}"
        interface: "$${2}"
        op: "$${3}"

    - match: 'truenas\.(.*)\.net_drops\.(.*)\.(.*)'
      match_type: "regex"
      name: "truenas_interface_drops"
      labels:
        job: "truenas"
        instance: "$${1}"
        interface: "$${2}"
        op: "$${3}"

    - match: 'truenas\.(.*)\.system\.net\.(.*)'
      match_type: "regex"
      name: "truenas_system_net_io"
      labels:
        job: "truenas"
        instance: "$${1}"
        op: "$${2}"

    ################################################
    # arcstat mapping
    ################################################

    - match: 'truenas\.(.*)\.truenas_arcstats\.(.*)\.(.*)'
      match_type: "regex"
      name: "truenas_arcstats"
      labels:
        job: "truenas"
        type: "$${2}"
        subtype: "$${3}"
        instance: "$${1}"

    ################################################
    # disk by ID mapping
    ################################################

    - match: 'truenas\.(.*)\.truenas_disk_stats\.(.*)\.(reads|writes)'
      match_type: "regex"
      name: "truenas_disk_io"
      labels:
        job: "truenas"
        disk: "$${2}"
        instance: "$${1}"
        op: "$${3}"
        unit: "KiB/s"

    - match: 'truenas\.(.*)\.truenas_disk_stats\.ops\.(.*)\.(read_ops|write_ops)'
      match_type: "regex"
      name: "truenas_disk_io_ops"
      labels:
        job: "truenas"
        disk: "$${2}"
        instance: "$${1}"
        op: "$${3}"
        unit: "op/s"

    - match: 'truenas\.(.*)\.truenas_disk_stats\.busy\.(.*)\.busy'
      match_type: "regex"
      name: "truenas_disk_busy"
      labels:
        job: "truenas"
        disk: "$${2}"
        instance: "$${1}"
        unit: "ms"

    ################################################
    # disk space and inodes
    ################################################

    - match: 'truenas\.(.*)\.disk_space\.(.*)\.used'
      match_type: "regex"
      name: "truenas_disk_bytes_used"
      labels:
        job: "truenas"
        mountpoint: "$${2}"
        instance: "$${1}"
        unit: "GiB"

    - match: 'truenas\.(.*)\.disk_space\.(.*)\.avail'
      match_type: "regex"
      name: "truenas_disk_bytes_avail"
      labels:
        job: "truenas"
        mountpoint: "$${2}"
        instance: "$${1}"
        unit: "GiB"

    - match: 'truenas\.(.*)\.disk_space\.(.*)\.reserved_for_root'
      match_type: "regex"
      name: "truenas_disk_bytes_reserved_for_root"
      labels:
        job: "truenas"
        mountpoint: "$${2}"
        instance: "$${1}"
        unit: "GiB"

    - match: 'truenas\.(.*)\.disk_inodes\.(.*)\.used'
      match_type: "regex"
      name: "truenas_disk_inodes_used"
      labels:
        job: "truenas"
        mountpoint: "$${2}"
        instance: "$${1}"
        unit: "inodes"

    - match: 'truenas\.(.*)\.disk_inodes\.(.*)\.avail'
      match_type: "regex"
      name: "truenas_disk_inodes_avail"
      labels:
        job: "truenas"
        mountpoint: "$${2}"
        instance: "$${1}"
        unit: "inodes"

    - match: 'truenas\.(.*)\.disk_inodes\.(.*)\.reserved_for_root'
      match_type: "regex"
      name: "truenas_disk_inodes_reserved_for_root"
      labels:
        job: "truenas"
        mountpoint: "$${2}"
        instance: "$${1}"
        unit: "inodes"
