---
# yaml-language-server: $schema=https://kubernetes-schemas.nerdz.cloud/external-secrets.io/externalsecret_v1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: pelican
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword-connect
  target:
    name: pelican-secret
    template:
      engineVersion: v2
      data:
        # App
        APP_KEY: "{{ .PELICAN_APP_KEY }}"
        APP_URL: https://pelican.${SECRET_DOMAIN}
        APP_ENV: production
        APP_DEBUG: "false"
        APP_TIMEZONE: ${TIMEZONE}
        TRUSTED_PROXIES: "10.0.0.0/8,172.16.0.0/12,192.168.0.0/16"
        BEHIND_PROXY: "true"

        # Database (new pelican database, cloned from pterodactyl)
        DB_CONNECTION: mysql
        DB_HOST: mariadb.database.svc.cluster.local
        DB_PORT: "3306"
        DB_DATABASE: pelican
        DB_USERNAME: pelican
        DB_PASSWORD: "{{ .PELICAN_MARIADB_PASSWORD }}"

        # Cache/Session/Queue via Redis (Dragonfly)
        CACHE_DRIVER: redis
        SESSION_DRIVER: redis
        QUEUE_CONNECTION: database
        REDIS_HOST: dragonfly.database.svc.cluster.local
        REDIS_PORT: "6379"
        REDIS_PASSWORD: ""

        # S3 Backups (MinIO)
        APP_BACKUP_DRIVER: s3
        AWS_DEFAULT_REGION: us-east-1
        AWS_ACCESS_KEY_ID: "{{ .MINIO_ACCESS_KEY }}"
        AWS_SECRET_ACCESS_KEY: "{{ .MINIO_SECRET_KEY }}"
        AWS_BACKUPS_BUCKET: gameserver-backups
        AWS_ENDPOINT: http://citadel.internal:9000
        AWS_USE_PATH_STYLE_ENDPOINT: "true"

        # Mail via smtp-relay
        MAIL_MAILER: smtp
        MAIL_HOST: smtp-relay.home.svc.cluster.local
        MAIL_PORT: "25"
        MAIL_USERNAME: ""
        MAIL_PASSWORD: ""
        MAIL_ENCRYPTION: "null"
        MAIL_FROM_ADDRESS: "{{ .PELICAN_ADMIN_EMAIL }}"
        MAIL_FROM_NAME: Pelican

        # PocketID OAuth
        OAUTH_POCKETID_CLIENT_ID: "{{ .PELICAN_POCKETID_CLIENTID }}"
        OAUTH_POCKETID_CLIENT_SECRET: "{{ .PELICAN_POCKETID_SECRET }}"
        OAUTH_POCKETID_BASE_URL: https://id.${SECRET_DOMAIN}
        OAUTH_POCKETID_DISPLAY_NAME: PocketID
        OAUTH_POCKETID_SHOULD_CREATE_MISSING_USERS: "true"
        OAUTH_POCKETID_SHOULD_LINK_MISSING_USERS: "true"

        # Server Documentation Plugin
        SERVER_DOCS_CACHE_TTL: "300"
        SERVER_DOCS_BADGE_CACHE_TTL: "60"
        SERVER_DOCS_VERSIONS_TO_KEEP: "50"
        SERVER_DOCS_AUTO_PRUNE: "true"
        SERVER_DOCS_MAX_IMPORT_SIZE: "512"
        SERVER_DOCS_ALLOW_HTML_IMPORT: "false"
        SERVER_DOCS_EXPLICIT_PERMISSIONS: "false"
        SERVER_DOCS_AUDIT_LOG_CHANNEL: single
  dataFrom:
    - extract:
        key: pelican
    - extract:
        key: pelican-shared
