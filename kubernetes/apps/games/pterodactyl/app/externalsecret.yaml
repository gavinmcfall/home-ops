---
# yaml-language-server: $schema=https://kubernetes-schemas.nerdz.cloud/external-secrets.io/externalsecret_v1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: pterodactyl
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword-connect
  target:
    name: pterodactyl-secret
    template:
      engineVersion: v2
      data:
        # App
        APP_KEY: "{{ .PTERODACTYL_APP_KEY }}"
        APP_URL: https://pterodactyl.${SECRET_DOMAIN}
        APP_ENV: production
        APP_DEBUG: "false"
        APP_TIMEZONE: ${TIMEZONE}

        # Database
        DB_CONNECTION: mysql
        DB_HOST: mariadb.database.svc.cluster.local
        DB_PORT: "3306"
        DB_DATABASE: pterodactyl
        DB_USERNAME: pterodactyl
        DB_PASSWORD: "{{ .PTERODACTYL_MARIADB_PASSWORD }}"

        # Cache/Session/Queue via Redis (Dragonfly)
        CACHE_DRIVER: redis
        SESSION_DRIVER: redis
        QUEUE_CONNECTION: redis
        REDIS_HOST: dragonfly.database.svc.cluster.local
        REDIS_PORT: "6379"
        REDIS_PASSWORD: ""

        # S3 Backups (MinIO)
        APP_BACKUP_DRIVER: s3
        AWS_DEFAULT_REGION: us-east-1
        AWS_ACCESS_KEY_ID: "{{ .MINIO_ACCESS_KEY }}"
        AWS_SECRET_ACCESS_KEY: "{{ .MINIO_SECRET_KEY }}"
        AWS_BACKUPS_BUCKET: gameserver-backups
        AWS_ENDPOINT: http://citadel.internal:9000
        AWS_USE_PATH_STYLE_ENDPOINT: "true"

        # Mail (disabled for now)
        MAIL_MAILER: log
  dataFrom:
    - extract:
        key: pterodactyl
    - extract:
        key: minio
