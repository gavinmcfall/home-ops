---
# yaml-language-server: $schema=https://kubernetes-schemas.nerdz.cloud/external-secrets.io/externalsecret_v1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: immich
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword-connect
  target:
    name: immich-secret
    template:
      engineVersion: v2
      data:
        DB_URL: "postgresql://{{ .IMMICH_POSTGRES_USER }}:{{ .IMMICH_POSTGRES_PASS }}@postgres18-immich-pooler.database.svc.cluster.local:5432/immich"
        INIT_POSTGRES_DBNAME: immich
        INIT_POSTGRES_HOST: postgres18-immich-rw.database.svc.cluster.local
        INIT_POSTGRES_USER: "{{ .IMMICH_POSTGRES_USER }}"
        INIT_POSTGRES_PASS: "{{ .IMMICH_POSTGRES_PASS }}"
        INIT_POSTGRES_SUPER_PASS: "{{ .POSTGRES_SUPER_PASS }}"
        # Immich config file - templated by ESO, secrets from 1Password
        # Note: Immich template vars like {{y}} must be quoted to escape ESO templating
        immich-config.yaml: |
          backup:
            database:
              enabled: false

          ffmpeg:
            accel: qsv
            accelDecode: true
            acceptedAudioCodecs:
              - aac
              - mp3
              - libopus
            acceptedContainers:
              - mov
              - ogg
              - webm
            acceptedVideoCodecs:
              - hevc
              - h264
            bframes: -1
            cqMode: auto
            crf: 23
            gopSize: 0
            maxBitrate: "0"
            preset: veryslow
            refs: 0
            targetAudioCodec: aac
            targetResolution: "1080"
            targetVideoCodec: h265
            temporalAQ: false
            threads: 0
            tonemap: "reinhard"
            transcode: required
            twoPass: false

          image:
            colorspace: p3
            extractEmbedded: false
            preview:
              format: jpeg
              quality: 80
              size: 1440
            thumbnail:
              format: webp
              quality: 80
              size: 250

          job:
            backgroundTask: { concurrency: 5 }
            faceDetection: { concurrency: 4 }
            library: { concurrency: 5 }
            metadataExtraction: { concurrency: 5 }
            migration: { concurrency: 10 }
            notifications: { concurrency: 5 }
            ocr: { concurrency: 3 }
            search: { concurrency: 10 }
            sidecar: { concurrency: 5 }
            smartSearch: { concurrency: 4 }
            thumbnailGeneration: { concurrency: 6 }
            videoConversion: { concurrency: 3 }

          library:
            scan:
              cronExpression: "0 0 * * *"
              enabled: true
            watch:
              enabled: false

          logging:
            enabled: true
            level: log

          machineLearning:
            enabled: true
            urls:
              - http://immich-machine-learning.entertainment.svc.cluster.local:3003
            clip:
              enabled: true
              modelName: ViT-SO400M-16-SigLIP2-384__webli
            duplicateDetection:
              enabled: true
              maxDistance: 0.01
            facialRecognition:
              enabled: true
              maxDistance: 0.5
              minFaces: 3
              minScore: 0.7
              modelName: buffalo_l
            ocr:
              enabled: true
              maxResolution: 1280
              minDetectionScore: 0.4
              minRecognitionScore: 0.6
              modelName: EN__PP-OCRv5_mobile

          map:
            enabled: true

          newVersionCheck:
            enabled: false

          notifications:
            smtp:
              enabled: true
              from: "{{ .SMTP_FROM }}"
              replyTo: ""
              transport:
                host: smtp-relay.home.svc.cluster.local
                port: 25
                ignoreCert: true

          oauth:
            enabled: true
            issuerUrl: https://id.${SECRET_DOMAIN}
            clientId: "{{ .IMMICH_OAUTH_CLIENT_ID }}"
            clientSecret: "{{ .IMMICH_OAUTH_CLIENT_SECRET }}"
            scope: openid profile email
            autoRegister: true
            buttonText: Login with Pocket-ID

          passwordLogin:
            enabled: false

          reverseGeocoding:
            enabled: true

          server:
            externalDomain: ""
            loginPageMessage: ""
            publicUsers: true
            loginPageMessage: Welcome to the "{{ .IMMICH_INSTANCE_NAME }}" Immich instance. Contact Gavin with any questions

          storageTemplate:
            enabled: true
            hashVerificationEnabled: true
            template: {{ printf "%q" "{{album}}/{{y}}/{{MM}}/{{filename}}" }}

          trash:
            enabled: true
            days: 30

          user:
            deleteDelay: 7
  dataFrom:
    - extract:
        key: immich
    - extract:
        key: cloudnative-pg
    - extract:
        key: smtp-relay
