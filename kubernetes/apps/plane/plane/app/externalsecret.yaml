---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/external-secrets.io/externalsecret_v1beta1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: plane
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword-connect
  target:
    name: plane-secret
    template:
      engineVersion: v2
      data:
        # Postgres connection (remote CloudNativePG instance)
        PGHOST: "postgres17-rw.database.svc.cluster.local"
        POSTGRES_PORT: "5432"
        POSTGRES_USER: "{{ .PLANE_DB_USER }}"
        POSTGRES_PASSWORD: "{{ .PLANE_DB_PASSWORD }}"
        POSTGRES_DB: "{{ .PLANE_DB_NAME }}"

        # Redis
        REDIS_URL: "redis://dragonfly.database.svc.cluster.local:6379"

        # Object storage (rook-ceph S3)
        AWS_S3_BUCKET_NAME: "{{ .PLANE_AWS_S3_BUCKET }}"
        FILE_SIZE_LIMIT: "157286400" # 150 MiB
        AWS_ACCESS_KEY_ID: "{{ .ROOK_AWS_ACCESS_KEY }}"
        AWS_SECRET_ACCESS_KEY: "{{ .ROOK_AWS_SECRET_ACCESS_KEY }}"
        AWS_REGION: "{{ .ROOK_AWS_S3_REGION }}"
        AWS_S3_ENDPOINT_URL: "{{ .ROOK_AWS_S3_ENDPOINT }}"

        # Public URLs & CORS
        NEXT_PUBLIC_DEPLOY_URL: "{{ .PLANE_NEXT_PUBLIC_DEPLOY_URL }}"
        CORS_ALLOWED_ORIGINS: "{{ .PLANE_CORS_ALLOWED_ORIGINS }}"

        # Runtime secrets (generate with `openssl rand -hex 32` before populating 1Password)
        SECRET_KEY: "{{ .PLANE_SECRET_KEY }}"


        # RabbitMQ (local broker credentials & endpoints)
        RABBITMQ_HOST: "plane-rabbitmq.home.svc.cluster.local"
        RABBITMQ_PORT: "5672"
        RABBITMQ_DEFAULT_USER: "{{ .PLANE_RABBITMQ_USERNAME }}"
        RABBITMQ_DEFAULT_PASS: "{{ .PLANE_RABBITMQ_PASSWORD }}"
        RABBITMQ_USER: "{{ .PLANE_RABBITMQ_USERNAME }}"
        RABBITMQ_PASSWORD: "{{ .PLANE_RABBITMQ_PASSWORD }}"

        # Misc
        API_KEY_RATE_LIMIT: "60/minute"
  dataFrom:
    - extract:
        key: plane
    - extract:
        key: cloudnative-pg
    - extract:
        key: rook-ceph
