---
# yaml-language-server: $schema=https://kubernetes-schemas.nerdz.cloud/external-secrets.io/externalsecret_v1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: tqm
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword-connect
  target:
    name: tqm-secret
    template:
      engineVersion: v2
      data:
        QBITTORRENT_PASSWORD: "{{ .QBITTORRENT_PASSWORD }}"
        config.yaml: |
          ---
          clients:
            qbt:
              download_path: /downloads/torrents/qbittorrent/completed
              enabled: true
              filter: default
              create_tags_upfront: false
              type: qbittorrent
              url: http://qbittorrent.downloads.svc.cluster.local
              user: admin
              password: "{{ .QBITTORRENT_PASSWORD }}"

          filters:
            default:
              ignore:
                # Don't touch torrents that are still downloading
                - Downloaded == false && !IsUnregistered()
                # Don't touch if tracker appears down
                - IsTrackerDown()
                # Don't touch very recently added torrents (1 day grace period)
                - AddedDays < 1 && !IsUnregistered()
                # Don't touch manual category
                - Label == "manual"

              remove:
                # Remove unregistered torrents (after 1 day grace period)
                - IsUnregistered() && AddedDays >= 1

                # Tracker-specific removal rules based on seed ratio/time
                # aither - no requirements
                - TrackerName contains "aither.cc" && (Ratio > 0 || SeedingDays >= 0.1)

                # alpharatio - 1.01 ratio or 7.1 days
                - TrackerName contains "alpharatio.cc" && (Ratio > 1.01 || SeedingDays >= 7.1)

                # anthelion - 1.01 ratio or 7.1 days
                - TrackerName contains "anthelion.me" && (Ratio > 1.01 || SeedingDays >= 7.1)

                # animetosho - 1.01 ratio or 7.1 days
                - TrackerName contains "animetosho.org" && (Ratio > 1.01 || SeedingDays >= 7.1)

                # avistaz - 0.91 ratio or 7.1 days (size-based HnR, using safe defaults)
                - TrackerName contains "avistaz.to" && (Ratio > 0.91 || SeedingDays >= 7.1)

                # exoticaz - 0.91 ratio or 7.1 days (size-based HnR, using safe defaults)
                - TrackerName contains "exoticaz.to" && (Ratio > 0.91 || SeedingDays >= 7.1)

                # pussytorrents - 0.41 ratio or 3.1 days (0.4 ratio or 60 hours within 72 hours)
                - TrackerName contains "pussytorrents.org" && (Ratio > 0.41 || SeedingDays >= 3.1)

                # beyond-hd - no requirements
                - TrackerName contains "beyond-hd.me" && (Ratio > 0 || SeedingDays >= 0.1)

                # blutopia - 0 ratio or 7.1 days
                - (TrackerName contains "blutopia.cc" || TrackerName contains "blutopia.xyz") && (Ratio > 0 || SeedingDays >= 7.1)

                # fearnopeer - 1.01 ratio or 7.1 days
                - TrackerName contains "fearnopeer.com" && (Ratio > 1.01 || SeedingDays >= 7.1)

                # filelist - 1.01 ratio or 2.1 days
                - (TrackerName contains "filelist.io" || TrackerName contains "flro.org") && (Ratio > 1.01 || SeedingDays >= 2.1)

                # hd-space - 0 ratio or 2.1 days
                - TrackerName contains "hd-space.pw" && (Ratio > 0 || SeedingDays >= 2.1)

                # hd-torrents - 1.01 ratio or 3.1 days
                - TrackerName contains "hdts-announce.ru" && (Ratio > 1.01 || SeedingDays >= 3.1)

                # iptorrents - 1.01 ratio or 14.1 days
                - (TrackerName contains "bgp.technology" || TrackerName contains "empirehost.me" || TrackerName contains "stackoverflow.tech") && (Ratio > 1.01 || SeedingDays >= 14.1)

                # myanonamouse - 1.01 ratio or 3.0 days
                - TrackerName contains "myanonamouse.net" && (Ratio > 1.01 || SeedingDays >= 3.0)

                # milkie - 1.01 ratio or 7.1 days
                - TrackerName contains "milkie.cc" && (Ratio > 1.01 || SeedingDays >= 7.1)

                # morethantv - 1.01 ratio or 7.1 days
                - TrackerName contains "morethantv.me" && (Ratio > 1.01 || SeedingDays >= 7.1)

                # nebulance - 0 ratio or 5.1 days
                - TrackerName contains "nebulance.io" && (Ratio > 0 || SeedingDays >= 5.1)

                # passthepopcorn - 1.01 ratio or 7.1 days
                - TrackerName contains "passthepopcorn.me" && (Ratio > 1.01 || SeedingDays >= 7.1)

                # privatehd - 0.91 ratio or 14.1 days
                - TrackerName contains "privatehd.to" && (Ratio > 0.91 || SeedingDays >= 14.1)

                # reelflix - 1.01 ratio or 7.1 days
                - TrackerName contains "reelflix.xyz" && (Ratio > 1.01 || SeedingDays >= 7.1)

                # scenetime - 1.01 ratio or 3.1 days
                - TrackerName contains "scenetime.com" && (Ratio > 1.01 || SeedingDays >= 3.1)

                # torrentday - 1.01 ratio or 3.1 days
                - (TrackerName contains "jumbohostpro.eu" || TrackerName contains "td-peers.com") && (Ratio > 1.01 || SeedingDays >= 3.1)

                # torrentleech - 1.01 ratio or 6.1 days
                - (TrackerName contains "tleechreload.org" || TrackerName contains "torrentleech.org") && (Ratio > 1.01 || SeedingDays >= 6.1)

                # torrentseeds - 1.01 ratio or 7.1 days
                - TrackerName contains "torrentseeds.org" && (Ratio > 1.01 || SeedingDays >= 7.1)

                # uhdbits - 1.01 ratio or 7.1 days
                - TrackerName contains "uhdbits.org" && (Ratio > 1.01 || SeedingDays >= 7.1)

              tag:
                # Tag unregistered torrents
                - name: unregistered
                  mode: full
                  update:
                    - IsUnregistered()

                # Tag expired torrents (met seed requirements)
                - name: expired
                  mode: full
                  update:
                    # aither
                    - TrackerName contains "aither.cc"
                    # beyond-hd
                    - TrackerName contains "beyond-hd.me"
                    # blutopia - 7.1 days
                    - (TrackerName contains "blutopia.cc" || TrackerName contains "blutopia.xyz") && SeedingDays >= 7.1
                    # hd-space - 2.1 days
                    - TrackerName contains "hd-space.pw" && SeedingDays >= 2.1
                    # nebulance - 5.1 days
                    - TrackerName contains "nebulance.io" && SeedingDays >= 5.1
                    # All others with ratio/time requirements
                    - TrackerName contains "alpharatio.cc" && (Ratio >= 1.01 || SeedingDays >= 7.1)
                    - TrackerName contains "anthelion.me" && (Ratio >= 1.01 || SeedingDays >= 7.1)
                    - TrackerName contains "animetosho.org" && (Ratio >= 1.01 || SeedingDays >= 7.1)
                    - TrackerName contains "avistaz.to" && (Ratio >= 0.91 || SeedingDays >= 7.1)
                    - TrackerName contains "exoticaz.to" && (Ratio >= 0.91 || SeedingDays >= 7.1)
                    - TrackerName contains "pussytorrents.org" && (Ratio >= 0.41 || SeedingDays >= 3.1)
                    - TrackerName contains "fearnopeer.com" && (Ratio >= 1.01 || SeedingDays >= 7.1)
                    - (TrackerName contains "filelist.io" || TrackerName contains "flro.org") && (Ratio >= 1.01 || SeedingDays >= 2.1)
                    - TrackerName contains "hdts-announce.ru" && (Ratio >= 1.01 || SeedingDays >= 3.1)
                    - (TrackerName contains "bgp.technology" || TrackerName contains "empirehost.me" || TrackerName contains "stackoverflow.tech") && (Ratio >= 1.01 || SeedingDays >= 14.1)
                    - TrackerName contains "myanonamouse.net" && (Ratio >= 1.01 || SeedingDays >= 3.0)
                    - TrackerName contains "milkie.cc" && (Ratio >= 1.01 || SeedingDays >= 7.1)
                    - TrackerName contains "morethantv.me" && (Ratio >= 1.01 || SeedingDays >= 7.1)
                    - TrackerName contains "passthepopcorn.me" && (Ratio >= 1.01 || SeedingDays >= 7.1)
                    - TrackerName contains "privatehd.to" && (Ratio >= 0.91 || SeedingDays >= 14.1)
                    - TrackerName contains "reelflix.xyz" && (Ratio >= 1.01 || SeedingDays >= 7.1)
                    - TrackerName contains "scenetime.com" && (Ratio >= 1.01 || SeedingDays >= 3.1)
                    - (TrackerName contains "jumbohostpro.eu" || TrackerName contains "td-peers.com") && (Ratio >= 1.01 || SeedingDays >= 3.1)
                    - (TrackerName contains "tleechreload.org" || TrackerName contains "torrentleech.org") && (Ratio >= 1.01 || SeedingDays >= 6.1)
                    - TrackerName contains "torrentseeds.org" && (Ratio >= 1.01 || SeedingDays >= 7.1)
                    - TrackerName contains "uhdbits.org" && (Ratio >= 1.01 || SeedingDays >= 7.1)

                # Tag by added time
                - name: added:1d
                  mode: full
                  update:
                    - AddedDays < 1

                # Tag by last activity
                - name: activity:1d
                  mode: full
                  update:
                    - LastActivityDays < 1
  dataFrom:
    - extract:
        key: qbittorrent
