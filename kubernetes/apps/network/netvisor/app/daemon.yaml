---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: netvisor-daemon
  labels:
    app.kubernetes.io/name: netvisor-daemon
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: netvisor-daemon
  template:
    metadata:
      labels:
        app.kubernetes.io/name: netvisor-daemon
    spec:
      hostNetwork: true
      dnsPolicy: ClusterFirstWithHostNet
      containers:
        - name: daemon
          image: mayanayza/netvisor-daemon:v0.10.4@sha256:0c6abd30d50c53340bf06b2b371293adc77764f17ec71d9ef24e972a221974d3
          securityContext:
            privileged: true
          env:
            - name: NETVISOR_SERVER_URL
              value: "http://netvisor.network.svc.cluster.local:60072"
            - name: NETVISOR_DAEMON_PORT
              value: "60073"
            - name: NETVISOR_BIND_ADDRESS
              value: "0.0.0.0"
            - name: NETVISOR_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            - name: NETVISOR_MODE
              value: "Push"
            - name: NETVISOR_LOG_LEVEL
              value: "info"
            - name: NETVISOR_HEARTBEAT_INTERVAL
              value: "30"
            - name: NETVISOR_CONCURRENT_SCANS
              value: "15"
          envFrom:
            - secretRef:
                name: netvisor-secret
          ports:
            - name: http
              containerPort: 60073
              hostPort: 60073
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /api/health
              port: 60073
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /api/health
              port: 60073
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          resources:
            requests:
              cpu: 50m
              memory: 128Mi
            limits:
              memory: 512Mi
          volumeMounts:
            - name: daemon-config
              mountPath: /root/.config/daemon
      volumes:
        - name: daemon-config
          hostPath:
            path: /var/lib/netvisor-daemon
            type: DirectoryOrCreate
      tolerations:
        - operator: Exists
