---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: llmd-modelservice
spec:
  interval: 30m
  chart:
    spec:
      chart: llm-d-modelservice
      sourceRef:
        kind: HelmRepository
        name: llm-d-modelservice
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      strategy: rollback
      retries: 3
  values:
    multinode: false
    modelArtifacts:
      name: random/model
      uri: "hf://{{ .Values.modelArtifacts.name }}"
      size: 5Mi
    routing:
      servicePort: 8000
      epp:
        create: true
        debugLevel: 6
        disableReadinessProbe: true
        disableLivenessProbe: true
      httpRoute:
        create: true
        matches:
          - headers:
            - name: x-model-name
              type: Exact
              value: "{{ .Values.modelArtifacts.name }}"
    decode:
      replicas: 1
      containers:
        - name: vllm
          image: ghcr.io/llm-d/llm-d-inference-sim:v0.3.0
          modelCommand: imageDefault
          ports:
            - containerPort: 8200
              protocol: TCP
          mountModelVolume: true
    prefill:
      replicas: 1
      containers:
        - name: vllm
          image: ghcr.io/llm-d/llm-d-inference-sim:v0.3.0
          modelCommand: imageDefault
          ports:
            - containerPort: 8000
              protocol: TCP
          mountModelVolume: true
