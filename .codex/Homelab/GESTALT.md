---
title: Homelab System Gestalt
purpose: Provide the mental model that makes the home-ops repo click in 15 minutes
audience: Gavin + automation agents working inside `~/home-ops`
verified: README.md / Taskfile.yaml / kubernetes/apps/games/romm/app/helmrelease.yaml
---

# Homelab System Gestalt

**One sentence**: A single GitOps repository that bootstraps Talos nodes, renders manifests via Taskfile + Makejinja, and lets Flux + ExternalSecrets keep every Kubernetes workload (apps, secrets, storage) in sync without leaking credentials.

**Why it feels complex**: Hardware bootstrap scripts (`bootstrap/`), Talos configs (`talosconfig/`), Taskfile orchestration (`Taskfile.yaml`, `.taskfiles/*`), and 40+ HelmRelease directories under `kubernetes/apps/*` all depend on placeholder secrets. Without a map itâ€™s easy to forget a `kustomization` entry, break Flux wiring, or deploy before vault secrets exist.

**Goal reading this**: Understand why the repo is structured this way, the non-negotiable invariants (GitOps authority, placeholder discipline, storage declarations), and exactly where to dig deeper when you change an app.

---

## ğŸ¯ The Core Pattern: Taskfile â†’ Flux â†’ ExternalSecrets

### Capsule: GitOpsPipeline âš™ï¸ AlwaysOn
Taskfile renders everything, Flux applies it, ExternalSecrets fills secrets.

```mermaid
flowchart LR
    Templates[Taskfile + Makejinja\n(Taskfile.yaml, .taskfiles/*)] --> Rendered[kubernetes/apps/* manifests]
    Rendered --> Flux[Flux Kustomizations\n(kubernetes/flux)]
    Flux --> Cluster[Kubernetes Cluster]
    Vault[ExternalSecrets / Vault] --> Cluster
    Cluster --> Dashboards[dashboards/ badges]

    classDef source fill:#81C784,stroke:#2E7D32;
    classDef flux fill:#90CAF9,stroke:#1565C0;
    classDef vault fill:#FFE082,stroke:#EF6C00;
    class Templates source
    class Rendered flux
    class Flux flux
    class Cluster flux
    class Vault vault
```

**Why**: Keeps every change auditable via Git. `task configure` (Taskfile.yaml + `.taskfiles/Kubernetes.yaml`) renders identical manifests for CI and local runs; Flux simply applies what Git already knows. ExternalSecrets references ensure secrets never appear in Git, matching the placeholder policy described in `TEMPLATE_GUIDE.md`.

**Where to dive deeper**: `ARCHITECTURE.md` (render decisions), `WORKFLOWS.md` (Helm onboarding), `kubernetes/apps/games/romm/app/helmrelease.yaml` (canonical manifest).

---

## ğŸ”’ Critical Invariants (Never Break)

### Capsule: GitOpsAuthority ğŸ”’
`task configure` â†’ `task kubernetes:kubeconform` â†’ `flux diff` â†’ PR â†’ Flux reconcile. Manual `kubectl apply` is forbidden; Flux will revert it and the doc loses integrity (`ARCHITECTURE.md`, `CONTRACTS.md`).

### Capsule: PlaceholderDiscipline ğŸ•µï¸
Every ingress, env var, or credential is a placeholder (`${SECRET_DOMAIN}`, `${MEDIA_SERVER}`, `${DB_URI}`, `PLANE_DB_URL`). ExternalSecrets (per app) resolve them. Never substitute real values in Git (see ROMM HelmRelease env + `externalsecret.yaml`).

### Capsule: StorageFirst ğŸ“¦
Persistence must be declared via PVC/NFS definitions before deployment. Example: ROMMâ€™s `persistence.media`, `existingClaim: romm-data`, and `advancedMounts` (`kubernetes/apps/games/romm/app/helmrelease.yaml:90-150`). Missing a mount leaves pods `Pending`.

### Capsule: FluxWiring ğŸ”Œ
Each area `kustomization.yaml` must reference the HelmRelease folder. Without it, Flux ignores the app (`kubernetes/apps/games/kustomization.yaml`). Always update kustomizations when adding/removing apps.

---

## ğŸ—ï¸ Repository Layers

| Layer | Location | Purpose | Notes |
|-------|----------|---------|-------|
| **Bootstrapping** | `bootstrap/`, `scripts/`, `talosconfig/` | Bring nodes online, generate Talos machine configs | Rendered via Taskfile + Makejinja before any Flux work. |
| **Render Pipeline** | `Taskfile.yaml`, `.taskfiles/*`, `makejinja.toml` | Defines `task init`, `task configure`, `task kubernetes:kubeconform`, flux helpers | Reinforces a RepoQL-style habitâ€”render/validate before diffing. |
| **GitOps Manifests** | `kubernetes/apps/<namespace>/app` & `kustomization.yaml` | HelmReleases, ExternalSecrets, ingress + storage definitions | Each app follows the triad: HelmRelease, ExternalSecret, kustomization entry. |
| **Flux Control** | `kubernetes/flux/` | Source definitions + CRDs Flux needs | Only touched when GitOps plumbing changes. |
| **Observability** | `dashboards/`, README badges | Surfaces Flux/cluster health | Update when new dashboards are added. |

---

## ğŸ§© Domain Capsules

- **Media Suite (ROMM)**: Complex storage + secret placeholders; best template for PVC + NFS + tmpfs combos. HelmRelease shows `advancedMounts`, ingress host substitution, and `dependsOn` usage.
- **Automations**: Renovate + GitHub Actions keep chart versions fresh. Documented in `README.md` + `.github/workflows`.
- **Talos Control Plane**: Node lifecycle locked to configs in `talosconfig/` generated by Taskfile. Never edit nodes manually; update the template and rerun `task configure` instead.

Use `DOMAIN.md` for rule tables/state diagrams when you need more than the capsule summary.

---

## ğŸ§ª When Things Break
- **Flux stuck in `Reconciling`** â†’ Check `flux get helmrelease <name>` then inspect placeholder values. Usually means ExternalSecret hasnâ€™t synced secrets yet (`WORKFLOWS.md`).
- **`task configure` fails** â†’ Missing placeholder in `bootstrap/config.yaml` or `.taskfiles` template. Document the new requirement in `TEMPLATE_GUIDE.md`.
- **Pods pending** â†’ Look for `existingClaim`/`nfs` definitions in HelmRelease; ensure the PVC exists and names match (ROMM reference).

Document every new failure or discovery in the appropriate doc so this gestalt stays accurate.

---

## Evidence
| Claim | Source | Confidence | Details |
|-------|:------:|:----------:|---------|
| Taskfile â†’ Flux â†’ ExternalSecrets pipeline | `Taskfile.yaml`, `.taskfiles/Kubernetes.yaml`, `kubernetes/apps/games/romm/app/helmrelease.yaml` | ğŸŸ¢ | Taskfile renders, Flux HelmRelease consumes, env values reference ExternalSecrets. |
| Placeholder + storage invariants | `kubernetes/apps/games/romm/app/helmrelease.yaml:65-150` | ğŸŸ¢ | Hosts, env vars, `persistence` sections all rely on placeholders + declared PVCs. |
| Flux wiring requirement | `kubernetes/apps/games/kustomization.yaml` | ğŸŸ¢ | HelmRelease directories listed; missing entry â†’ Flux skip. |
| Bootstrapping layers exist | `bootstrap/`, `talosconfig/`, `scripts/` | ğŸŸ¢ | Provide Talos machine configs + scripts referenced in README + Taskfile. |
