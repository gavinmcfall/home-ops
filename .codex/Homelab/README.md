# Homelab Infrastructure Playbook

## Service Identity
**Type**: Infrastructure-as-Code + GitOps automation hub
**Domain**: Home Kubernetes cluster + supporting tooling (Flux, Talos, monitoring)

## üë• Ownership
**Team**: Solo maintainer (Gavin)
**Signals**: #home-operations Discord channel
**On-Call**: Self-managed; GitHub Actions, Flux, and automated Taskfile recipes handle most fixes

## Why This Exists
This repository tracks every artifact required to boot, configure, and operate the home Kubernetes cluster. The `bootstrap/` scripts, `talosconfig/` definitions, and `Taskfile`/`makejinja.toml` templates render manifests that Flux applies under `kubernetes/apps/*` so the cluster stays in sync from a single Git source [README.md:41-130].

## Service Boundaries
### ‚úÖ This Repository Owns
- Bootstrapping node hardware via `bootstrap/` scripts, `scripts/`, and Talos configs under `talosconfig/`.
- Flux-based GitOps manifests under `kubernetes/apps/*`, including HelmReleases, ExternalSecrets, and ingress/secret wiring.
- Repository tooling (`Taskfile.yaml`, `.taskfiles/*`, `makejinja.toml`) that renders configs, validates with `task kubernetes:kubeconform`, and packages secrets safely.

### ‚ùå This Repository Does NOT Own
- External DNS providers or private 1Password vaults; only placeholders such as `${SECRET_DOMAIN}` or `${DB_URI}` appear in Git.
- Cloud-native managed services; all dependencies (storage, Vault, monitoring dashboards) are on-prem or self-hosted.

## ‚ö†Ô∏è Gotchas
- Flux requires each area (`kubernetes/apps/games`, `kubernetes/apps/plane`, etc.) to list its HelmRelease in a `kustomization`; missing references stop syncing [kubernetes/apps/games/romm/app/helmrelease.yaml].
- Secrets are populated via ExternalSecrets, so reloads fail until placeholders (e.g., `PLANE_DB_URL`, `${SECRET_DOMAIN}`) are resolved by the private vault.
- Storage-heavy workloads like ROMM rely on multiple mounts (PVCs, tmpfs, NFS); changing claim names or servers without matching config leads to pods pending [kubernetes/apps/games/romm/app/helmrelease.yaml:102-140].

## Integration Map
### Dependencies (Inbound)
| System | Purpose | Notes |
|--------|---------|-------|
| Flux (`gitops-system`) | Reconciles manifests under `kubernetes/apps/*` and watches HelmReleases | Every change runs `flux diff` or `flux reconcile` after `Taskfile` renders new templates |
| Taskfile + Makejinja | Renders templates (scripts, configs) before commits | `Taskfile.yaml` includes `.taskfiles/Kubernetes`, `.taskfiles/Talos`, `.taskfiles/Flux`, etc. |
| ExternalSecrets + placeholder vault | Supplies secrets referenced by `${SECRET_DOMAIN}`, `PLANE_*`, or `romm-secret` | Secrets never land in Git; they point at secure vault keys |

### Consumers (Outbound)
| Service | What They Use | SLA |
|---------|---------------|-----|
| Flux | HelmRelease + kustomization outputs | Idempotent deployment; fails fast on missing placeholders |
| Monitoring dashboards | Expose status badges referenced in `README.md` | ~5 minute reconciliation update |

### Events
- **Publishes**: GitHub Actions creates PRs, Renovate updates chart versions, and Taskfile validations log to stdout.
- **Consumes**: Flux responds to Git pushes, ExternalSecrets polls vault changes, and Taskfile tasks are triggered manually or via GitHub workflows.

## Getting Started
```bash
task init
task configure
task kubernetes:kubeconform
flux diff kustomization games --path=kubernetes/apps/games/romm/app
```

## Common Tasks
- **Add a new app**: create `kubernetes/apps/<area>/app/helmrelease.yaml`, `externalsecret.yaml`, and wire it into the area `kustomization.yaml`.
- **Refresh secrets**: edit placeholders in `ExternalSecret` resources and rerun your vault sync; check `kubernetes/apps/<area>/app` for env references.
- **Validate manifests**: `task kubernetes:kubeconform` followed by `flux diff kustomization <area>` ensures Flux will accept the change.

## Key Concepts
- **GitOps Manifests**: `kubernetes/apps/*` contains per-area overlays; HelmRelease specs pin chart versions and tags for predictable rollouts.
- **Bootstrapping**: Scripts under `bootstrap/`, `scripts/`, and templates generated by `makejinja` supply Talos config values and secrets placeholders.
- **ExternalSecrets**: Secrets are never stored in Git; all workloads pull them via names such as `romm-secret` or `plane-secret` defined beside the HelmRelease.

## Workflows
- **Cluster updates**: edit Talos configs ‚Üí `task configure` ‚Üí `flux diff` ‚Üí commit + push ‚Üí Flux applies.
- **Helm rollout**: bump HelmRelease image/tag ‚Üí `task kubernetes:kubeconform` ‚Üí `flux diff` ‚Üí merge PR ‚Üí watch Flux reconcile.

## Troubleshooting
- Run `flux get kustomizations` to confirm all overlays are healthy.
- Use `helm template` against the HelmRelease values in `kubernetes/apps/games/romm/app/helmrelease.yaml` to catch render issues.
- Substitute `${SECRET_DOMAIN}` before testing ingresses; the repo uses placeholders for every public host.

## Evidence
| Claim | Source | Confidence | Details |
|-------|:------:|:----------:|---------|
| GitOps + Flux workflow | `README.md:41-130`, `kubernetes/apps/games/romm/app/helmrelease.yaml:2-140` | üü¢ | Root README describes Flux/Taskfile usage; HelmRelease demonstrates real values/dependsOn. |
| Bootstrapping tools | `Taskfile.yaml`, `bootstrap/`, `talosconfig/` | üü¢ | Taskfile includes `.taskfiles/Kubernetes`, `.taskfiles/Talos`, Bootstrapping happens inside `bootstrap` scripts. |
| Placeholder/secrets strategy | `kubernetes/apps/games/romm/app/helmrelease.yaml:65-140` | üü¢ | `${SECRET_DOMAIN}`, `existingClaim`, `tmpfs`, and env secrets documented. |
